# syntax=docker/dockerfile:1
# Build stage
FROM mcr.microsoft.com/dotnet/sdk:10.0@sha256:0a506ab0c8aa077361af42f82569d364ab1b8741e967955d883e3f23683d473a AS build
WORKDIR /src

# Clear Windows-specific NuGet fallback folders that break Linux builds
RUN printf '<configuration><fallbackPackageFolders><clear /></fallbackPackageFolders></configuration>' \
    > /src/NuGet.config

COPY RockBot.slnx .
COPY src/ src/

# BuildKit cache mount avoids re-downloading packages on every build
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish src/RockBot.Agent/RockBot.Agent.csproj \
    -c Release -o /app/publish

# Runtime stage â€” console app only, no ASP.NET Core needed
FROM mcr.microsoft.com/dotnet/runtime:10.0@sha256:3de49150e48790fa845547e14bff5add0e4194a8901e727cf88f83423bcbe2b0 AS runtime
WORKDIR /app

# Non-root user
RUN groupadd -r rockbot && useradd -r -g rockbot rockbot

# Published app
COPY --from=build /app/publish .

# /data/agent is the PVC mount point; create it so the image starts cleanly
# even without a volume (e.g. local dev without k8s)
RUN mkdir -p /data/agent && chown -R rockbot:rockbot /app /data

USER rockbot

ENTRYPOINT ["dotnet", "RockBot.Agent.dll"]
